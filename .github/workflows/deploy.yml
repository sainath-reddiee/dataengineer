name: Build and Deploy to Hostinger (Incremental)

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'package.json'
      - 'functions.php'
      - 'package-lock.json'
      - 'vite.config.js'
      - 'tailwind.config.js'
      - 'postcss.config.js'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        type: choice
        default: 'incremental'
        options:
          - 'incremental'
          - 'force-rebuild'
          - 'full-with-categories'
          - 'posts-only'
          - 'nuclear-redeploy'
      skip_cache:
        description: 'Skip build cache?'
        required: false
        type: boolean
        default: false
      skip_deploy:
        description: 'Build only (skip deployment)?'
        required: false
        type: boolean
        default: false
      verify_build:
        description: 'Run build verification?'
        required: false
        type: boolean
        default: true
      notify_search_engines:
        description: 'Notify search engines?'
        required: false
        type: boolean
        default: true
      dry_run:
        description: 'Dry run (test without actual deployment)?'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 21 * * *'
  repository_dispatch:
    types: [post-published]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ” Detect Changes & Configure Build
        id: changes
        run: |
          echo "trigger=${{ github.event_name }}" >> $GITHUB_OUTPUT
          
          # Detect code changes
          if git diff --name-only HEAD^ HEAD | grep -qE '^(src/|index.html|vite.config.js|tailwind.config.js|package)'; then
            echo "code_changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ”¨ Code changes detected - full rebuild needed"
          else
            echo "code_changed=false" >> $GITHUB_OUTPUT
            echo "ğŸ“„ Only content/config changed"
          fi
          
          # Configure build based on trigger type and inputs
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BUILD_TYPE="${{ github.event.inputs.build_type }}"
            SKIP_CACHE="${{ github.event.inputs.skip_cache }}"
            SKIP_DEPLOY="${{ github.event.inputs.skip_deploy }}"
            VERIFY_BUILD="${{ github.event.inputs.verify_build }}"
            NOTIFY_SE="${{ github.event.inputs.notify_search_engines }}"
            DRY_RUN="${{ github.event.inputs.dry_run }}"
            
            echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
            echo "skip_cache=$SKIP_CACHE" >> $GITHUB_OUTPUT
            echo "skip_deploy=$SKIP_DEPLOY" >> $GITHUB_OUTPUT
            echo "verify_build=$VERIFY_BUILD" >> $GITHUB_OUTPUT
            echo "notify_search_engines=$NOTIFY_SE" >> $GITHUB_OUTPUT
            echo "dry_run=$DRY_RUN" >> $GITHUB_OUTPUT
            
            # Set dangerous clean slate flag for nuclear option
            if [ "$BUILD_TYPE" == "nuclear-redeploy" ]; then
              echo "use_clean_slate=true" >> $GITHUB_OUTPUT
              echo "â˜¢ï¸  NUCLEAR REDEPLOY MODE ENABLED"
            else
              echo "use_clean_slate=false" >> $GITHUB_OUTPUT
            fi
            
            echo "ğŸ® Manual trigger with options:"
            echo "  - Build Type: $BUILD_TYPE"
            echo "  - Skip Cache: $SKIP_CACHE"
            echo "  - Skip Deploy: $SKIP_DEPLOY"
            echo "  - Verify Build: $VERIFY_BUILD"
            echo "  - Notify Search Engines: $NOTIFY_SE"
            echo "  - Dry Run: $DRY_RUN"
          else
            # Default behavior for automated triggers
            echo "build_type=incremental" >> $GITHUB_OUTPUT
            echo "skip_cache=false" >> $GITHUB_OUTPUT
            echo "skip_deploy=false" >> $GITHUB_OUTPUT
            echo "verify_build=true" >> $GITHUB_OUTPUT
            echo "notify_search_engines=true" >> $GITHUB_OUTPUT
            echo "dry_run=false" >> $GITHUB_OUTPUT
            echo "use_clean_slate=false" >> $GITHUB_OUTPUT
          fi
          
          # Determine build flags
          case "${{ github.event.inputs.build_type }}" in
            "force-rebuild"|"nuclear-redeploy")
              echo "build_flags=--posts-only --force" >> $GITHUB_OUTPUT
              echo "ğŸ”¨ Force rebuild all posts"
              ;;
            "full-with-categories")
              echo "build_flags=--force" >> $GITHUB_OUTPUT
              echo "ğŸ“š Full rebuild including categories/tags"
              ;;
            "posts-only")
              echo "build_flags=--posts-only" >> $GITHUB_OUTPUT
              echo "ğŸ“„ Posts only (no force)"
              ;;
            *)
              echo "build_flags=--posts-only" >> $GITHUB_OUTPUT
              echo "âš¡ Incremental build"
              ;;
          esac

      - name: ğŸ’¾ Restore Build Cache
        id: cache-restore
        if: steps.changes.outputs.skip_cache != 'true'
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.npm
            dist
            public/sitemap.xml
            public/indexnow-key.txt
            .build-cache.json
          key: build-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('src/**', 'index.html', 'vite.config.js', 'tailwind.config.js', 'postcss.config.js') }}
          restore-keys: |
            build-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        if: steps.cache-restore.outputs.cache-hit != 'true' || steps.changes.outputs.code_changed == 'true' || steps.changes.outputs.skip_cache == 'true'
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ—ºï¸ Generate & Validate Sitemap
        if: |
          steps.cache-restore.outputs.cache-hit != 'true' || 
          github.event_name == 'repository_dispatch' || 
          github.event_name == 'schedule' ||
          steps.changes.outputs.skip_cache == 'true'
        run: |
          npm run sitemap:generate || echo "âš ï¸ Sitemap generation skipped"
          npm run sitemap:validate || echo "âš ï¸ Sitemap validation skipped"
          npm run llm-sitemap || echo "âš ï¸ LLM sitemap generation skipped"
        continue-on-error: true

      - name: ğŸ—ï¸ Build Application (Vite)
        if: steps.cache-restore.outputs.cache-hit != 'true' || steps.changes.outputs.code_changed == 'true' || steps.changes.outputs.skip_cache == 'true'
        run: npm run build:vite
        env:
          NODE_ENV: production
          VITE_ADS_ENABLED: ${{ secrets.VITE_ADS_ENABLED }}
          VITE_ADSENSE_PUBLISHER_ID: ${{ secrets.VITE_ADSENSE_PUBLISHER_ID }}
          VITE_GA_MEASUREMENT_ID: ${{ secrets.VITE_GA_MEASUREMENT_ID }}
          VITE_ADMIN_USERNAME: ${{ secrets.VITE_ADMIN_USERNAME }}
          VITE_ADMIN_PASSWORD: ${{ secrets.VITE_ADMIN_PASSWORD }}
          VITE_GEMINI_API_KEY: ${{ secrets.VITE_GEMINI_API_KEY }}

      - name: ğŸ—‘ï¸ Delete Build Cache (Force Fresh Build)
        if: |
          steps.changes.outputs.build_type == 'force-rebuild' || 
          steps.changes.outputs.build_type == 'nuclear-redeploy'
        run: |
          rm -f .build-cache.json
          echo "ğŸ—‘ï¸ Build cache deleted - all pages will be regenerated with unique timestamps"
          echo "âœ… This ensures FTP will detect file changes and upload them"

      - name: ğŸ“„ Generate Static Pages
        id: static_pages
        run: |
          # Get build flags from previous step
          BUILD_FLAGS="${{ steps.changes.outputs.build_flags }}"
          
          echo "ğŸš€ Running build with flags: $BUILD_FLAGS"
          node scripts/generateStaticPagesIncremental.js $BUILD_FLAGS
          
          # âš ï¸ CRITICAL: Verify articles exist before deploying
          echo ""
          echo "ğŸ” Verifying article pages in dist/..."
          
          if [ ! -d "dist/articles" ]; then
            echo "âŒ ERROR: dist/articles directory not found!"
            echo "ğŸ”¨ Forcing complete rebuild of all pages..."
            node scripts/generateStaticPagesIncremental.js --posts-only --force
          fi
          
          # Count article pages
          ARTICLE_COUNT=$(find dist/articles -name 'index.html' 2>/dev/null | wc -l || echo "0")
          echo "ğŸ“Š Found $ARTICLE_COUNT article pages in dist/"
          
          if [ "$ARTICLE_COUNT" -eq 0 ]; then
            echo "âŒ CRITICAL: No articles found in dist/articles!"
            echo "This would cause the FTP sync to delete all articles from the server."
            echo ""
            echo "Attempting one final forced rebuild..."
            node scripts/generateStaticPagesIncremental.js --posts-only --force
            
            # Re-check after force rebuild
            ARTICLE_COUNT=$(find dist/articles -name 'index.html' 2>/dev/null | wc -l || echo "0")
            
            if [ "$ARTICLE_COUNT" -eq 0 ]; then
              echo "âŒ FATAL: Still no articles after forced rebuild!"
              echo "Deployment aborted to prevent data loss."
              exit 1
            fi
          fi
          
          echo "âœ… Deployment ready with $ARTICLE_COUNT article pages"
          
          # Generate FAQ schemas for articles
          echo ""
          echo "ğŸ“‹ Generating FAQ schemas..."
          npm run faq-schema || echo "âš ï¸ FAQ schema generation skipped"
          
          # Verify build output
          echo ""
          echo "ğŸ” Verifying build output..."
          npm run build:verify || echo "âš ï¸ Build verification skipped"
          echo "article_count=$ARTICLE_COUNT" >> $GITHUB_OUTPUT
          echo "build_completed=true" >> $GITHUB_OUTPUT
          
          # Add to summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“„ Static Pages Generated" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Articles:** $ARTICLE_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type:** ${{ steps.changes.outputs.build_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Flags:** \`$BUILD_FLAGS\`" >> $GITHUB_STEP_SUMMARY
          
          if [[ "$BUILD_FLAGS" == *"--posts-only"* ]]; then
            echo "- â„¹ï¸  **Note:** Categories and tags are handled dynamically by React" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ” Verify Build (Optional)
        if: steps.changes.outputs.verify_build == 'true'
        run: |
          echo "ğŸ” Running build verification..."
          npm run build:verify || {
            echo "âš ï¸ Build verification found issues but continuing..."
            echo "Check the logs above for details"
          }
        continue-on-error: true

      - name: â„¹ï¸ Build Status
        run: |
          echo "## ğŸ“Š Build Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "**Manual Options:**" >> $GITHUB_STEP_SUMMARY
            echo "- Build Type: ${{ steps.changes.outputs.build_type }}" >> $GITHUB_STEP_SUMMARY
            echo "- Skip Cache: ${{ steps.changes.outputs.skip_cache }}" >> $GITHUB_STEP_SUMMARY
            echo "- Skip Deploy: ${{ steps.changes.outputs.skip_deploy }}" >> $GITHUB_STEP_SUMMARY
            echo "- Verify Build: ${{ steps.changes.outputs.verify_build }}" >> $GITHUB_STEP_SUMMARY
            echo "- Dry Run: ${{ steps.changes.outputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.cache-restore.outputs.cache-hit }}" == "true" ] && [ "${{ steps.changes.outputs.skip_cache }}" != "true" ]; then
            if [ "${{ steps.changes.outputs.code_changed }}" == "true" ]; then
              echo "ğŸ”¨ Code changed - full rebuild performed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš¡ Using cached build + incremental pages" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ğŸ†• Fresh build completed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Show what triggered this build
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“ WordPress Content Update" >> $GITHUB_STEP_SUMMARY
            echo "Triggered by: Post published/updated in WordPress" >> $GITHUB_STEP_SUMMARY
            echo "Only changed pages were regenerated!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ”‘ Generate IndexNow Key
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          const crypto = require('crypto');
          
          const publicDir = path.join(process.cwd(), 'public');
          const keyFile = path.join(publicDir, 'indexnow-key.txt');
          
          if (!fs.existsSync(publicDir)) {
            fs.mkdirSync(publicDir, { recursive: true });
          }
          
          if (fs.existsSync(keyFile)) {
            const key = fs.readFileSync(keyFile, 'utf8').trim();
            console.log('âœ… Using existing key:', key);
          } else {
            const key = crypto.randomBytes(16).toString('hex');
            fs.writeFileSync(keyFile, key, 'utf8');
            const verificationFile = path.join(publicDir, \`\${key}.txt\`);
            fs.writeFileSync(verificationFile, key, 'utf8');
            console.log('ğŸ”‘ Generated new key:', key);
          }
          "

      - name: ğŸ“‹ Prepare Files
        run: |
          mkdir -p dist
          
          [ -f "public/sitemap.xml" ] && cp public/sitemap.xml dist/ && echo "âœ… Copied sitemap.xml"
          [ -f "public/robots.txt" ] && cp public/robots.txt dist/ && echo "âœ… Copied robots.txt"
          [ -f "public/.htaccess" ] && cp public/.htaccess dist/ && echo "âœ… Copied .htaccess"
          
          find public -name "*.txt" -exec cp {} dist/ \; 2>/dev/null && echo "âœ… Copied .txt files" || echo "âš ï¸ No .txt files found"
          
          echo "âœ… Files prepared for deployment"

      - name: ğŸ—‘ï¸ Clear FTP Sync State (Force Upload All Files)
        if: |
          steps.changes.outputs.build_type == 'force-rebuild' || 
          steps.changes.outputs.build_type == 'nuclear-redeploy'
        run: |
          echo "ğŸ—‘ï¸ Removing FTP sync state to force re-upload of all files..."
          rm -f .ftp-deploy-sync-state.json
          echo "âœ… FTP sync state cleared - ALL files will be uploaded"
          echo ""
          echo "This ensures that even if file timestamps are the same,"
          echo "the FTP tool will re-upload everything because it has no"
          echo "previous state to compare against."
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”„ Force Upload Enabled" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ FTP sync state cleared - all files will be re-uploaded regardless of changes" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ Each HTML file contains unique build timestamp to ensure file content differs" >> $GITHUB_STEP_SUMMARY

      - name: ğŸš€ Deploy to Hostinger (FTPS)
        if: steps.changes.outputs.skip_deploy != 'true'
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 21
          protocol: ftps
          security: loose
          local-dir: ./dist/
          server-dir: /public_html/
          dangerous-clean-slate: ${{ steps.changes.outputs.use_clean_slate == 'true' }}
          state-name: .ftp-deploy-sync-state.json
          dry-run: ${{ steps.changes.outputs.dry_run == 'true' }}
          timeout: 300000
          log-level: standard
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env
            **/.DS_Store
            **/Thumbs.db
            **/.build-cache.json

      - name: â­ï¸ Deployment Skipped
        if: steps.changes.outputs.skip_deploy == 'true'
        run: |
          echo "â­ï¸ Deployment skipped by user request" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build completed successfully but was not deployed." >> $GITHUB_STEP_SUMMARY

      - name: â¸ï¸ Smart Wait
        if: steps.changes.outputs.skip_deploy != 'true' && steps.changes.outputs.dry_run != 'true'
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "âš¡ WordPress update - quick wait (5s)"
            sleep 5
          elif [ "${{ steps.cache-restore.outputs.cache-hit }}" == "true" ]; then
            echo "âš¡ Cache hit - minimal wait (3s)"
            sleep 3
          else
            echo "â³ Full deploy - waiting 8s for propagation"
            sleep 8
          fi

      - name: ğŸ” Deployment Verification
        if: steps.changes.outputs.skip_deploy != 'true' && steps.changes.outputs.dry_run != 'true'
        run: |
          echo "ğŸ” Verifying deployment..."
          
          if curl -sf -o /dev/null -w "%{http_code}" https://dataengineerhub.blog/ | grep -q "200"; then
            echo "âœ… Main site is accessible"
          else
            echo "âš ï¸ Main site check failed"
          fi
          
          if curl -sf -o /dev/null https://dataengineerhub.blog/sitemap.xml; then
            echo "âœ… Sitemap is accessible"
          else
            echo "âš ï¸ Sitemap not found"
          fi
          
          if curl -sf -o /dev/null https://dataengineerhub.blog/robots.txt; then
            echo "âœ… Robots.txt is accessible"
          else
            echo "âš ï¸ Robots.txt not found"
          fi
          
          if [ -f "public/indexnow-key.txt" ]; then
            KEY=$(cat public/indexnow-key.txt | tr -d '[:space:]')
            if curl -sf -o /dev/null "https://dataengineerhub.blog/${KEY}.txt"; then
              echo "âœ… IndexNow key verification file is accessible"
            else
              echo "âš ï¸ IndexNow key verification failed"
            fi
          fi
          
          # Verify a sample article
          SAMPLE_ARTICLE=$(find dist/articles -name 'index.html' | head -1 | sed 's|dist||' | sed 's|/index.html||')
          if [ ! -z "$SAMPLE_ARTICLE" ]; then
            if curl -sf -o /dev/null "https://dataengineerhub.blog${SAMPLE_ARTICLE}"; then
              echo "âœ… Sample article is accessible: ${SAMPLE_ARTICLE}"
            else
              echo "âš ï¸ Sample article check failed: ${SAMPLE_ARTICLE}"
            fi
          fi
        continue-on-error: true

      - name: ğŸ“¢ Notify Search Engines
        if: |
          steps.changes.outputs.skip_deploy != 'true' && 
          steps.changes.outputs.dry_run != 'true' &&
          steps.changes.outputs.notify_search_engines == 'true' &&
          (steps.cache-restore.outputs.cache-hit != 'true' || 
           github.event_name == 'repository_dispatch' || 
           github.event_name == 'schedule')
        run: |
          npm run sitemap:notify || echo "âš ï¸ Search engine notification queued"
        continue-on-error: true
        timeout-minutes: 2

      - name: ğŸ“Š Deployment Summary
        run: |
          echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Deployment status
          if [ "${{ steps.changes.outputs.dry_run }}" == "true" ]; then
            echo "### ğŸ§ª Dry Run Mode" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Build completed successfully (no actual deployment)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.changes.outputs.skip_deploy }}" == "true" ]; then
            echo "### â­ï¸ Build Only" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Build completed successfully (deployment skipped by user)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Deployment Complete" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Show build type
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“ WordPress Content Update" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Only changed pages were regenerated and deployed" >> $GITHUB_STEP_SUMMARY
            echo "â±ï¸ **Build Type:** Incremental (Fast)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.changes.outputs.build_type }}" == "nuclear-redeploy" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### â˜¢ï¸ Nuclear Redeploy" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Complete wipe and redeploy - all files uploaded fresh" >> $GITHUB_STEP_SUMMARY
            echo "â±ï¸ **Build Type:** Nuclear (Complete Reset)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.changes.outputs.build_type }}" == "force-rebuild" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ”¨ Force Rebuild" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All pages regenerated with unique timestamps and force uploaded" >> $GITHUB_STEP_SUMMARY
            echo "â±ï¸ **Build Type:** Full (Forced)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.changes.outputs.build_type }}" == "full-with-categories" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“š Full Build" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All pages including categories and tags regenerated" >> $GITHUB_STEP_SUMMARY
            echo "â±ï¸ **Build Type:** Complete" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.cache-restore.outputs.cache-hit }}" == "true" ] && [ "${{ steps.changes.outputs.skip_cache }}" != "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš¡ Cache Hit" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Using cached build with incremental updates" >> $GITHUB_STEP_SUMMARY
            echo "â±ï¸ **Time Saved:** ~50-70 seconds" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ†• Fresh Build" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Complete build from scratch" >> $GITHUB_STEP_SUMMARY
            echo "â±ï¸ **Build Type:** Full" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ [Live Site](https://dataengineerhub.blog)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ—ºï¸ [Sitemap](https://dataengineerhub.blog/sitemap.xml)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¤– [Robots.txt](https://dataengineerhub.blog/robots.txt)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ˆ Build Info" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.static_pages.outputs.article_count }}" != "" ]; then
            echo "- **Articles:** ${{ steps.static_pages.outputs.article_count }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.changes.outputs.verify_build }}" == "true" ]; then
            echo "- **Verification:** âœ… Enabled" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ’¾ Save Cache
        if: |
          steps.changes.outputs.skip_cache != 'true' &&
          (steps.cache-restore.outputs.cache-hit != 'true' || steps.changes.outputs.code_changed == 'true')
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.npm
            dist
            public/sitemap.xml
            public/indexnow-key.txt
            .build-cache.json
          key: build-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('src/**', 'index.html', 'vite.config.js', 'tailwind.config.js', 'postcss.config.js') }}

      - name: ğŸ’¾ Upload Artifact
        if: |
          steps.changes.outputs.skip_deploy == 'true' ||
          steps.cache-restore.outputs.cache-hit != 'true' || 
          github.event_name == 'repository_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ github.run_number }}
          path: |
            dist/
            public/sitemap.xml
            .build-cache.json
          retention-days: 7
        continue-on-error: true

  validate-sitemap:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ—ºï¸ Generate Sitemap
        run: npm run sitemap:generate
        continue-on-error: true
      
      - name: âœ… Validate Sitemap
        run: npm run sitemap:validate
        continue-on-error: true
      
      - name: ğŸ’¬ PR Comment
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            let body = '## ğŸ—ºï¸ Sitemap Validation\n\n';
            
            if (fs.existsSync('public/sitemap.xml')) {
              const content = fs.readFileSync('public/sitemap.xml', 'utf8');
              const urlCount = (content.match(/<url>/g) || []).length;
              
              body += `âœ… Sitemap generated successfully!\n\n`;
              body += `ğŸ“Š **Stats:**\n`;
              body += `- URLs: ${urlCount}\n`;
              body += `- Size: ${(content.length / 1024).toFixed(2)} KB\n`;
            } else {
              body += `âš ï¸ Sitemap not found. This may be expected if sitemap generation is optional.\n`;
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
        continue-on-error: true
