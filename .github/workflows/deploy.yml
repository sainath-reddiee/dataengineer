name: Build and Deploy to Hostinger (Incremental)

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'package.json'
      - 'functions.php'
      - 'package-lock.json'
      - 'vite.config.js'
      - 'tailwind.config.js'
      - 'postcss.config.js'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all pages'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 21 * * *'
  repository_dispatch:
    types: [post-published]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ” Detect Changes & Trigger Type
        id: changes
        run: |
          echo "trigger=${{ github.event_name }}" >> $GITHUB_OUTPUT
          
          if git diff --name-only HEAD^ HEAD | grep -qE '^(src/|index.html|vite.config.js|tailwind.config.js|package)'; then
            echo "code_changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ”¨ Code changes detected - full rebuild needed"
          else
            echo "code_changed=false" >> $GITHUB_OUTPUT
            echo "ğŸ“„ Only content/config changed"
          fi
          
          # Determine if force rebuild is needed
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.force_rebuild }}" == "true" ]; then
            echo "force_rebuild=true" >> $GITHUB_OUTPUT
            echo "âš¡ Manual force rebuild requested"
          else
            echo "force_rebuild=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’¾ Restore Build Cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.npm
            dist
            public/sitemap.xml
            public/indexnow-key.txt
            .build-cache.json
          key: build-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('src/**', 'index.html', 'vite.config.js', 'tailwind.config.js', 'postcss.config.js') }}
          restore-keys: |
            build-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        if: steps.cache-restore.outputs.cache-hit != 'true' || steps.changes.outputs.code_changed == 'true'
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ—ºï¸ Generate & Validate Sitemap
        if: |
          steps.cache-restore.outputs.cache-hit != 'true' || 
          github.event_name == 'repository_dispatch' || 
          github.event_name == 'schedule'
        run: |
          npm run sitemap:generate || echo "âš ï¸ Sitemap generation skipped"
          npm run sitemap:validate || echo "âš ï¸ Sitemap validation skipped"
        continue-on-error: true

      - name: ğŸ—ï¸ Build Application (Vite)
        if: steps.cache-restore.outputs.cache-hit != 'true' || steps.changes.outputs.code_changed == 'true'
        run: npm run build:vite
        env:
          NODE_ENV: production
          VITE_ADS_ENABLED: ${{ secrets.VITE_ADS_ENABLED }}
          VITE_ADSENSE_PUBLISHER_ID: ${{ secrets.VITE_ADSENSE_PUBLISHER_ID }}
          VITE_GA_MEASUREMENT_ID: ${{ secrets.VITE_GA_MEASUREMENT_ID }}

      # ====================================================================
      # â¬‡ï¸ START OF THE FIX
      # ====================================================================
      - name: ğŸ“„ Generate Static Pages (Incremental - Posts Only)
        id: static_pages
        run: |
          # Always use --posts-only flag (categories/tags handled by React)
          BUILD_FLAGS="--posts-only"
          
          if [ "${{ steps.changes.outputs.force_rebuild }}" == "true" ]; then
            BUILD_FLAGS="--posts-only --force"
            echo "ğŸ”¨ Force rebuilding all article pages"
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "ğŸ“ WordPress triggered - incremental article update"
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            echo "â° Scheduled build - checking for changed articles"
          fi
          
          # Run incremental build (posts only)
          # We call node directly to pass our custom flags, bypassing the npm script
          echo "Running: node scripts/generateStaticPagesIncremental.js $BUILD_FLAGS"
          node scripts/generateStaticPagesIncremental.js $BUILD_FLAGS
          
          # Parse build output for statistics
          echo "build_completed=true" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸  **Note:** Categories and tags are handled dynamically by React" >> $GITHUB_STEP_SUMMARY
      # ====================================================================
      # â¬†ï¸ END OF THE FIX
      # ====================================================================

      - name: â„¹ï¸ Build Status
        run: |
          echo "## ğŸ“Š Build Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.cache-restore.outputs.cache-hit }}" == "true" ]; then
            if [ "${{ steps.changes.outputs.code_changed }}" == "true" ]; then
              echo "ğŸ”¨ Code changed - full rebuild performed" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš¡ Using cached build + incremental pages" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ğŸ†• Fresh build completed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Show what triggered this build
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“ WordPress Content Update" >> $GITHUB_STEP_SUMMARY
            echo "Triggered by: Post published/updated in WordPress" >> $GITHUB_STEP_SUMMARY
            echo "Only changed pages were regenerated!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ”‘ Generate IndexNow Key
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          const crypto = require('crypto');
          
          const publicDir = path.join(process.cwd(), 'public');
          const keyFile = path.join(publicDir, 'indexnow-key.txt');
          
          if (!fs.existsSync(publicDir)) {
            fs.mkdirSync(publicDir, { recursive: true });
          }
          
          if (fs.existsSync(keyFile)) {
            const key = fs.readFileSync(keyFile, 'utf8').trim();
            console.log('âœ… Using existing key:', key);
          } else {
            const key = crypto.randomBytes(16).toString('hex');
            fs.writeFileSync(keyFile, key, 'utf8');
            const verificationFile = path.join(publicDir, \`\${key}.txt\`);
            fs.writeFileSync(verificationFile, key, 'utf8');
            console.log('ğŸ”‘ Generated new key:', key);
          }
          "

      - name: ğŸ“‹ Prepare Files
        run: |
          mkdir -p dist
          
          [ -f "public/sitemap.xml" ] && cp public/sitemap.xml dist/ && echo "âœ… Copied sitemap.xml"
          [ -f "public/robots.txt" ] && cp public/robots.txt dist/ && echo "âœ… Copied robots.txt"
          [ -f "public/.htaccess" ] && cp public/.htaccess dist/ && echo "âœ… Copied .htaccess"
          
          find public -name "*.txt" -exec cp {} dist/ \; 2>/dev/null && echo "âœ… Copied .txt files" || echo "âš ï¸ No .txt files found"
          
          echo "âœ… Files prepared for deployment"

      - name: ğŸš€ Deploy to Hostinger (FTPS)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: 21
          protocol: ftps
          security: loose
          local-dir: ./dist/
          server-dir: /public_html/
          dangerous-clean-slate: false
          state-name: .ftp-deploy-sync-state.json
          dry-run: false
          timeout: 300000
          log-level: standard
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env
            **/.DS_Store
            **/Thumbs.db
            **/.build-cache.json

      - name: â¸ï¸ Smart Wait
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "âš¡ WordPress update - quick wait (5s)"
            sleep 5
          elif [ "${{ steps.cache-restore.outputs.cache-hit }}" == "true" ]; then
            echo "âš¡ Cache hit - minimal wait (3s)"
            sleep 3
          else
            echo "â³ Full deploy - waiting 8s for propagation"
            sleep 8
          fi

      - name: ğŸ” Deployment Verification
        run: |
          echo "ğŸ” Verifying deployment..."
          
          if curl -sf -o /dev/null -w "%{http_code}" https://dataengineerhub.blog/ | grep -q "200"; then
            echo "âœ… Main site is accessible"
          else
            echo "âš ï¸ Main site check failed"
          fi
          
          if curl -sf -o /dev/null https://dataengineerhub.blog/sitemap.xml; then
            echo "âœ… Sitemap is accessible"
          else
            echo "âš ï¸ Sitemap not found"
          fi
          
          if curl -sf -o /dev/null https://dataengineerhub.blog/robots.txt; then
            echo "âœ… Robots.txt is accessible"
          else
            echo "âš ï¸ Robots.txt not found"
          fi
          
          if [ -f "public/indexnow-key.txt" ]; then
            KEY=$(cat public/indexnow-key.txt | tr -d '[:space:]')
            if curl -sf -o /dev/null "https://dataengineerhub.blog/${KEY}.txt"; then
              echo "âœ… IndexNow key verification file is accessible"
            else
              echo "âš ï¸ IndexNow key verification failed"
            fi
          fi
        continue-on-error: true

      - name: ğŸ“¢ Notify Search Engines
        if: |
          steps.cache-restore.outputs.cache-hit != 'true' || 
          github.event_name == 'repository_dispatch' || 
          github.event_name == 'schedule'
        run: |
          npm run sitemap:notify || echo "âš ï¸ Search engine notification queued"
        continue-on-error: true
        timeout-minutes: 2

      - name: ğŸ“Š Deployment Summary
        run: |
          echo "## ğŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show build type
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "### ğŸ“ WordPress Content Update" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Only changed pages were regenerated and deployed" >> $GITHUB_STEP_SUMMARY
            echo "â±ï¸ **Build Type:** Incremental (Fast)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.changes.outputs.force_rebuild }}" == "true" ]; then
            echo "### ğŸ”¨ Force Rebuild" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All pages regenerated" >> $GITHUB_STEP_SUMMARY
            echo "â±ï¸ **Build Type:** Full (Forced)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.cache-restore.outputs.cache-hit }}" == "true" ]; then
            echo "### âš¡ Cache Hit" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Using cached build with incremental updates" >> $GITHUB_STEP_SUMMARY
            echo "â±ï¸ **Time Saved:** ~50-70 seconds" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ğŸ†• Fresh Build" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Complete build from scratch" >> $GITHUB_STEP_SUMMARY
            echo "â±ï¸ **Build Type:** Full" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ [Live Site](https://dataengineerhub.blog)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ—ºï¸ [Sitemap](https://dataengineerhub.blog/sitemap.xml)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¤– [Robots.txt](https://dataengineerhub.blog/robots.txt)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ˆ Build Info" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¾ Save Cache
        if: steps.cache-restore.outputs.cache-hit != 'true' || steps.changes.outputs.code_changed == 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.npm
            dist
            public/sitemap.xml
            public/indexnow-key.txt
            .build-cache.json
          key: build-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('src/**', 'index.html', 'vite.config.js', 'tailwind.config.js', 'postcss.config.js') }}

      - name: ğŸ’¾ Upload Artifact
        if: steps.cache-restore.outputs.cache-hit != 'true' || github.event_name == 'repository_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ github.run_number }}
          path: |
            dist/
            public/sitemap.xml
            .build-cache.json
          retention-days: 7
        continue-on-error: true

  validate-sitemap:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ—ºï¸ Generate Sitemap
        run: npm run sitemap:generate
        continue-on-error: true
      
      - name: âœ… Validate Sitemap
        run: npm run sitemap:validate
        continue-on-error: true
      
      - name: ğŸ’¬ PR Comment
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            let body = '## ğŸ—ºï¸ Sitemap Validation\n\n';
            
            if (fs.existsSync('public/sitemap.xml')) {
              const content = fs.readFileSync('public/sitemap.xml', 'utf8');
              const urlCount = (content.match(/<url>/g) || []).length;
              
              body += `âœ… Sitemap generated successfully!\n\n`;
              body += `ğŸ“Š **Stats:**\n`;
              body += `- URLs: ${urlCount}\n`;
              body += `- Size: ${(content.length / 1024).toFixed(2)} KB\n`;
            } else {
              body += `âš ï¸ Sitemap not found. This may be expected if sitemap generation is optional.\n`;
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
        continue-on-error: true
